<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Vessel Tracker</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        
        #header {
            background: #16213e;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        #header h1 {
            font-size: 24px;
            color: #00d4ff;
        }
        
        #stats {
            display: flex;
            gap: 30px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #aaa;
            text-transform: uppercase;
        }
        
        #controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #aaa;
        }
        
        .filter-group select {
            background: #0f3460;
            color: #eee;
            border: 1px solid #00d4ff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        #map {
            height: calc(100vh - 120px);
            width: calc(100% - 400px);
            position: relative;
            float: left;
        }
        
        /* Sidebar Panel */
        #sidebar {
            width: 400px;
            height: calc(100vh - 120px);
            background: #16213e;
            float: right;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            padding: 20px;
            display: none;
        }
        
        #sidebar.active {
            display: block;
        }
        
        #sidebar h2 {
            color: #00d4ff;
            font-size: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 10px;
        }
        
        #sidebar .close-btn {
            float: right;
            background: #ff0000;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        #sidebar .close-btn:hover {
            background: #cc0000;
        }
        
        #sidebar .info-section {
            margin-bottom: 20px;
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
        }
        
        #sidebar .info-section h3 {
            color: #00d4ff;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        #sidebar .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #1a1a2e;
        }
        
        #sidebar .info-row:last-child {
            border-bottom: none;
        }
        
        #sidebar .info-label {
            color: #aaa;
            font-size: 13px;
        }
        
        #sidebar .info-value {
            color: #fff;
            font-size: 13px;
            font-weight: bold;
        }
        
        /* Legend */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: rgba(22, 33, 62, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 1000;
            min-width: 200px;
        }
        
        .legend h3 {
            color: #00d4ff;
            font-size: 14px;
            margin-bottom: 10px;
            border-bottom: 1px solid #00d4ff;
            padding-bottom: 5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 12px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        
        .legend-size {
            font-size: 11px;
            color: #aaa;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #444;
        }
        
        /* Enhanced Popup */
        .leaflet-popup-content-wrapper {
            background: #16213e;
            color: #fff;
            border-radius: 8px;
        }
        
        .leaflet-popup-content {
            margin: 15px;
            min-width: 280px !important;
        }
        
        .leaflet-popup-tip {
            background: #16213e;
        }
        
        .vessel-popup {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-width: 300px;
        }
        
        .vessel-popup h3 {
            margin: 0 0 10px 0;
            color: #00d4ff;
            font-size: 18px;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 5px;
        }
        
        .vessel-photo {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .vessel-photo-placeholder {
            width: 100%;
            height: 150px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            position: relative;
        }
        
        .photo-loading {
            width: 100%;
            height: 150px;
            background: #2a2a3e;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .photo-loading-text {
            color: #00d4ff;
            font-size: 12px;
        }
        
        .vessel-popup table {
            width: 100%;
            font-size: 13px;
        }
        
        .vessel-popup td {
            padding: 4px 5px;
            vertical-align: top;
        }
        
        .vessel-popup td:first-child {
            font-weight: bold;
            color: #666;
            width: 100px;
        }
        
        .vessel-popup .ship-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .type-passenger { background: #ff00ff; color: white; }
        .type-cargo { background: #00ff00; color: black; }
        .type-tanker { background: #ff0000; color: white; }
        .type-other { background: #00d4ff; color: black; }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-active {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }
        
        .status-inactive {
            background: #666;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üö¢ Real-Time Vessel Tracker</h1>
        
        <div style="display: flex; gap: 10px;">
            <a href="/ships/fleet-visualization" class="btn" style="background: #0f3460; color: #00d4ff; border: 1px solid #00d4ff; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; transition: all 0.3s;">üåê 3D Fleet</a>
            <a href="/ships/sql" class="btn" style="background: #0f3460; color: #00d4ff; border: 1px solid #00d4ff; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; transition: all 0.3s;">üíª SQL Query</a>
            <a href="/ships/database" class="btn" style="background: #0f3460; color: #00d4ff; border: 1px solid #00d4ff; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; transition: all 0.3s;">üóÑÔ∏è Database</a>
        </div>
        
        <div id="controls">
            <div class="filter-group">
                <label>Type:</label>
                <select id="filter-type">
                    <option value="all">All Types</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Size:</label>
                <select id="filter-size">
                    <option value="all">All Sizes</option>
                    <option value="large">Large (‚â•200m)</option>
                    <option value="medium">Medium (100-200m)</option>
                </select>
            </div>
        </div>
        
        <div id="stats">
            <div class="stat">
                <div class="stat-value" id="total-vessels">0</div>
                <div class="stat-label">Total Vessels</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="active-vessels">0</div>
                <div class="stat-label">Active Tracking</div>
            </div>
            <div class="stat">
                <div class="stat-label">
                    <span class="status-indicator status-active"></span>
                    Live Updates
                </div>
            </div>
        </div>
    </div>
    
    <div id="map">
        <div class="legend" style="max-height: 500px; overflow-y: auto;">
            <h3>üé® Ship Type Colors</h3>
            <div class="legend-item">
                <div class="legend-color" style="background: #8B4513;"></div>
                <span>Bulk carrier</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF4500;"></div>
                <span>Container ship</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #32CD32;"></div>
                <span>General cargo</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #DC143C;"></div>
                <span>Oil tanker</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF1493;"></div>
                <span>Chemical tanker</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9370DB;"></div>
                <span>LNG carrier</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #BA55D3;"></div>
                <span>Gas carrier</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFD700;"></div>
                <span>Vehicle carrier</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFA500;"></div>
                <span>Ro-ro ship</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00CED1;"></div>
                <span>Refrigerated cargo</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #1E90FF;"></div>
                <span>Passenger ship</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #808080;"></div>
                <span>Other types</span>
            </div>
            <div class="legend-size">
                <strong>Size:</strong><br>
                ‚Ä¢ Large dot = ‚â•200m<br>
                ‚Ä¢ Small dot = 100-200m
            </div>
        </div>
    </div>
    
    <div id="sidebar">
        <button class="close-btn" onclick="closeSidebar()">‚úï Close</button>
        <h2 id="sidebar-title">Vessel Details</h2>
        <div id="sidebar-content"></div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // Initialize map - centered to show Europe and Atlantic routes
        const map = L.map('map').setView([48.0, -10.0], 5);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Store markers and vessel data
        const markers = {};
        let allVessels = [];
        let currentFilters = {
            type: 'all',
            size: 'all'
        };
        let currentRoute = null; // Store current route polyline
        let currentRouteMarkers = []; // Store route start/end markers
        const photoCache = {}; // Cache photo results to avoid repeated requests
        
        // Detailed ship type colors (based on EU MRV detailed_ship_type)
        const detailedShipTypeColors = {
            'Bulk carrier': '#8B4513',              // Brown
            'Container ship': '#FF4500',            // Orange-Red
            'Container/ro-ro cargo ship': '#FF6347', // Tomato
            'General cargo ship': '#32CD32',        // Lime Green
            'Oil tanker': '#DC143C',                // Crimson
            'Chemical tanker': '#FF1493',           // Deep Pink
            'LNG carrier': '#9370DB',               // Medium Purple
            'Gas carrier': '#BA55D3',               // Medium Orchid
            'Vehicle carrier': '#FFD700',           // Gold
            'Ro-ro ship': '#FFA500',                // Orange
            'Ro-pax ship': '#FF8C00',               // Dark Orange
            'Refrigerated cargo carrier': '#00CED1', // Dark Turquoise
            'Passenger ship': '#1E90FF',            // Dodger Blue
            'Passenger ship (Cruise Passenger ship)': '#4169E1', // Royal Blue
            'Combination carrier': '#20B2AA',       // Light Sea Green
            'Other ship types': '#808080',          // Gray
            'Other ship types (Offshore)': '#696969' // Dim Gray
        };
        
        // Fallback colors for AIS ship type codes (if no detailed_ship_type)
        const aisShipTypeColors = {
            70: '#00ff00', // Cargo - Green
            80: '#ff0000'  // Tanker - Red
        };
        
        function getShipTypeInfo(vessel) {
            // Prefer detailed_ship_type from emissions data
            if (vessel.detailed_ship_type && detailedShipTypeColors[vessel.detailed_ship_type]) {
                return {
                    color: detailedShipTypeColors[vessel.detailed_ship_type],
                    name: vessel.detailed_ship_type,
                    badge: 'type-detailed'
                };
            }
            
            // Fallback to AIS ship_type
            const shipType = vessel.ship_type;
            if (shipType >= 70 && shipType < 80) {
                return { color: aisShipTypeColors[70], name: 'Cargo', badge: 'type-cargo' };
            }
            if (shipType >= 80 && shipType < 90) {
                return { color: aisShipTypeColors[80], name: 'Tanker', badge: 'type-tanker' };
            }
            
            // Default
            return { color: '#00ff00', name: 'Cargo', badge: 'type-cargo' };
        }
        
        // Create custom icon
        function createVesselIcon(vessel) {
            const isLarge = vessel.length >= 200;
            const typeInfo = getShipTypeInfo(vessel);
            const color = typeInfo.color;
            const isWindAssisted = vessel.wind_assisted === 1;
            
            // Add wind propulsion indicator (wind turbine icon)
            const windIndicator = isWindAssisted ? `<div style="position: absolute; top: -8px; right: -8px; font-size: 16px; filter: drop-shadow(0 0 3px #000);">üå¨Ô∏è</div>` : '';
            
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="position: relative;"><div style="background: ${color}; border: 2px solid ${isWindAssisted ? '#00ff00' : '#fff'}; border-radius: 50%; width: ${isLarge ? 16 : 12}px; height: ${isLarge ? 16 : 12}px; box-shadow: 0 0 ${isLarge ? 15 : 10}px ${color};"></div>${windIndicator}</div>`,
                iconSize: [isLarge ? 24 : 20, isLarge ? 24 : 20],
                iconAnchor: [isLarge ? 12 : 10, isLarge ? 12 : 10]
            });
        }
        
        // Create enhanced popup content with ship photo
        function createPopupContent(mmsi, vessel) {
            const hasPosition = vessel.lat !== undefined;
            const typeInfo = getShipTypeInfo(vessel);
            
            const popupId = `popup-${mmsi}`;
            
            const content = `
                <div class="vessel-popup" id="${popupId}">
                    <h3>${vessel.name}</h3>
                    <div class="photo-loading" id="photo-${mmsi}">
                        <div class="spinner"></div>
                        <div class="photo-loading-text">Loading photo...</div>
                    </div>
                    <span class="ship-type-badge ${typeInfo.badge}">${typeInfo.name}</span>
                    ${vessel.detailed_ship_type ? `<br><span style="font-size: 12px; color: #666;">Type: ${vessel.detailed_ship_type}</span>` : ''}
                    ${vessel.wind_assisted === 1 ? `
                        <br><span style="font-size: 13px; color: #00ff00; font-weight: bold;">üå¨Ô∏è Wind-Assisted Propulsion</span>
                        <div id="popup-wind-tech-${mmsi}" style="font-size: 11px; color: #aaa; margin-top: 5px;">Loading technology details...</div>
                    ` : ''}
                    <table>
                        <tr><td>MMSI:</td><td>${mmsi}</td></tr>
                        <tr><td>Flag:</td><td>${vessel.flag_state || 'Unknown'}</td></tr>
                        <tr><td>Length:</td><td>${vessel.length}m</td></tr>
                        <tr><td>Type Code:</td><td>${vessel.ship_type || 'N/A'}</td></tr>
                        ${vessel.imo ? `<tr><td>IMO:</td><td>${vessel.imo}</td></tr>` : ''}
                        ${vessel.call_sign ? `<tr><td>Call Sign:</td><td>${vessel.call_sign}</td></tr>` : ''}
                        ${hasPosition ? `
                            <tr><td>Position:</td><td>${vessel.lat.toFixed(4)}¬∞N, ${vessel.lon.toFixed(4)}¬∞E</td></tr>
                            <tr><td>Speed:</td><td>${vessel.sog} knots</td></tr>
                            <tr><td>Course:</td><td>${vessel.cog}¬∞</td></tr>
                            <tr><td>Updated:</td><td>${new Date(vessel.timestamp).toLocaleString()}</td></tr>
                        ` : '<tr><td colspan="2"><em>Waiting for position...</em></td></tr>'}
                    </table>
                </div>
            `;
            
            // Fetch photo asynchronously (with caching)
            setTimeout(() => {
                const photoContainer = document.getElementById(`photo-${mmsi}`);
                if (!photoContainer) return;
                
                // Check cache first
                if (photoCache[mmsi] !== undefined) {
                    if (photoCache[mmsi]) {
                        photoContainer.innerHTML = `<img src="${photoCache[mmsi]}" class="vessel-photo" alt="${vessel.name}" onerror="this.parentElement.innerHTML='<div class=\\'vessel-photo-placeholder\\'>üö¢</div>'">`;
                    } else {
                        photoContainer.innerHTML = '<div class="vessel-photo-placeholder">üö¢</div>';
                    }
                    return;
                }
                
                // Fetch from API
                fetch(`/ships/api/vessel/${mmsi}/photo`)
                    .then(response => {
                        if (!response.ok) throw new Error('Photo fetch failed');
                        return response.json();
                    })
                    .then(data => {
                        const photoUrl = data.photo_url;
                        photoCache[mmsi] = photoUrl; // Cache the result
                        
                        if (photoContainer) {
                            if (photoUrl) {
                                photoContainer.innerHTML = `<img src="${photoUrl}" class="vessel-photo" alt="${vessel.name}" onerror="this.parentElement.innerHTML='<div class=\\'vessel-photo-placeholder\\'>üö¢</div>'; photoCache[${mmsi}] = null;">`;
                            } else {
                                photoContainer.innerHTML = '<div class="vessel-photo-placeholder">üö¢</div>';
                            }
                        }
                    })
                    .catch(error => {
                        console.error(`Error loading photo for ${mmsi}:`, error);
                        photoCache[mmsi] = null; // Cache the failure
                        if (photoContainer) {
                            photoContainer.innerHTML = '<div class="vessel-photo-placeholder">üö¢</div>';
                        }
                    });
            }, 100);
            
            // Fetch wind technology details if vessel has wind propulsion
            if (vessel.wind_assisted === 1) {
                setTimeout(() => {
                    fetch(`/ships/api/vessel/${mmsi}/wind-tech`)
                        .then(response => response.json())
                        .then(data => {
                            const techDiv = document.getElementById(`popup-wind-tech-${mmsi}`);
                            if (techDiv && data.found) {
                                techDiv.innerHTML = `<strong>${data.technology}</strong><br>Installed: ${data.year} (${data.type})`;
                                techDiv.style.color = '#00ff00';
                            } else if (techDiv) {
                                techDiv.innerHTML = 'Wind-assisted (details pending)';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading wind tech:', error);
                            const techDiv = document.getElementById(`popup-wind-tech-${mmsi}`);
                            if (techDiv) {
                                techDiv.innerHTML = 'Wind-assisted propulsion';
                            }
                        });
                }, 150);
            }
            
            return content;
        }
        
        // Check if vessel passes filters
        function passesFilters(vessel) {
            // Detailed type filter (by detailed_ship_type from emissions data)
            if (currentFilters.type !== 'all') {
                if (!vessel.detailed_ship_type || vessel.detailed_ship_type !== currentFilters.type) {
                    return false;
                }
            }
            
            // Size filter
            if (currentFilters.size !== 'all') {
                if (currentFilters.size === 'large' && vessel.length < 200) return false;
                if (currentFilters.size === 'medium' && (vessel.length < 100 || vessel.length >= 200)) return false;
            }
            
            return true;
        }
        
        // Update vessel marker
        function updateVessel(mmsi, vessel) {
            if (!vessel.lat || !vessel.lon) return;
            
            // Check if vessel passes filters
            if (!passesFilters(vessel)) {
                // Remove marker if it exists
                if (markers[mmsi]) {
                    map.removeLayer(markers[mmsi]);
                    delete markers[mmsi];
                }
                return;
            }
            
            if (markers[mmsi]) {
                // Update existing marker
                markers[mmsi].setLatLng([vessel.lat, vessel.lon]);
                markers[mmsi].setPopupContent(createPopupContent(mmsi, vessel));
            } else {
                // Create new marker
                const marker = L.marker([vessel.lat, vessel.lon], {
                    icon: createVesselIcon(vessel)
                }).addTo(map);
                
                marker.bindPopup(createPopupContent(mmsi, vessel), {
                    maxWidth: 350,
                    minWidth: 300,
                    className: 'vessel-info-popup'
                });
                
                // Add click handler to show sidebar and route
                marker.on('click', () => {
                    showVesselDetails(mmsi, vessel);
                    showVesselRoute(mmsi, vessel.name);
                });
                
                markers[mmsi] = marker;
            }
            
            // Update stats
            updateStats();
        }
        
        // Apply filters to all vessels
        function applyFilters() {
            // Clear all markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            Object.keys(markers).forEach(key => delete markers[key]);
            
            // Re-add vessels that pass filters
            allVessels.forEach(vessel => {
                if (vessel.lat && vessel.lon) {
                    updateVessel(vessel.mmsi, vessel);
                }
            });
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('active-vessels').textContent = Object.keys(markers).length;
        }
        
        // Show vessel details in sidebar
        function showVesselDetails(mmsi, vessel) {
            const sidebar = document.getElementById('sidebar');
            const title = document.getElementById('sidebar-title');
            const content = document.getElementById('sidebar-content');
            
            title.textContent = vessel.name || 'Unknown Vessel';
            
            const typeInfo = getShipTypeInfo(vessel);
            const hasPosition = vessel.lat !== undefined;
            
            content.innerHTML = `
                <div class="info-section">
                    <h3>üìã Basic Information</h3>
                    <div class="info-row">
                        <span class="info-label">MMSI</span>
                        <span class="info-value">${mmsi}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Vessel Name</span>
                        <span class="info-value">${vessel.name || 'Unknown'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Flag State</span>
                        <span class="info-value">${vessel.flag_state || 'Unknown'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ship Type</span>
                        <span class="info-value">${typeInfo.name} (${vessel.ship_type || 'N/A'})</span>
                    </div>
                    ${vessel.detailed_ship_type ? `
                    <div class="info-row">
                        <span class="info-label">Detailed Type</span>
                        <span class="info-value">${vessel.detailed_ship_type}</span>
                    </div>
                    ` : ''}
                    ${vessel.signatory_company ? `
                    <div class="info-row">
                        <span class="info-label">Company</span>
                        <span class="info-value">${vessel.signatory_company}</span>
                    </div>
                    ` : ''}
                </div>
                
                ${vessel.wind_assisted === 1 ? `
                <div class="info-section" style="background: linear-gradient(135deg, #1a3a1a 0%, #2d5a2d 100%); border-left: 4px solid #00ff00;">
                    <h3>üå¨Ô∏è Wind-Assisted Propulsion</h3>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value" style="color: #00ff00; font-weight: bold;">‚úì INSTALLED</span>
                    </div>
                    <div id="wind-tech-details-${mmsi}" class="info-row">
                        <span class="info-label">Technology</span>
                        <span class="info-value">Loading...</span>
                    </div>
                </div>
                ` : ''}
                
                <div class="info-section">
                    <h3>üìè Dimensions</h3>
                    <div class="info-row">
                        <span class="info-label">Length</span>
                        <span class="info-value">${vessel.length || 'N/A'}m</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Beam</span>
                        <span class="info-value">${vessel.beam || 'N/A'}m</span>
                    </div>
                    ${vessel.imo ? `
                    <div class="info-row">
                        <span class="info-label">IMO Number</span>
                        <span class="info-value">${vessel.imo}</span>
                    </div>
                    ` : ''}
                    ${vessel.call_sign ? `
                    <div class="info-row">
                        <span class="info-label">Call Sign</span>
                        <span class="info-value">${vessel.call_sign}</span>
                    </div>
                    ` : ''}
                </div>
                
                ${hasPosition ? `
                <div class="info-section">
                    <h3>üìç Current Position</h3>
                    <div class="info-row">
                        <span class="info-label">Latitude</span>
                        <span class="info-value">${vessel.lat.toFixed(6)}¬∞</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Longitude</span>
                        <span class="info-value">${vessel.lon.toFixed(6)}¬∞</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Speed</span>
                        <span class="info-value">${vessel.sog || 0} knots</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Course</span>
                        <span class="info-value">${vessel.cog || 0}¬∞</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Update</span>
                        <span class="info-value">${new Date(vessel.timestamp).toLocaleString()}</span>
                    </div>
                </div>
                ` : '<div class="info-section"><em>Waiting for position data...</em></div>'}
                
                <div class="info-section">
                    <h3>üîó External Links</h3>
                    <a href="https://www.marinetraffic.com/en/ais/details/ships/mmsi:${mmsi}" target="_blank" style="color: #00d4ff; display: block; margin: 10px 0;">View on MarineTraffic ‚Üí</a>
                    <a href="https://www.vesselfinder.com/vessels?name=${encodeURIComponent(vessel.name || '')}" target="_blank" style="color: #00d4ff; display: block; margin: 10px 0;">Search on VesselFinder ‚Üí</a>
                </div>
            `;
            
            sidebar.classList.add('active');
            
            // Fetch wind technology details if vessel has wind propulsion
            if (vessel.wind_assisted === 1) {
                fetch(`/ships/api/vessel/${mmsi}/wind-tech`)
                    .then(response => response.json())
                    .then(data => {
                        const detailsDiv = document.getElementById(`wind-tech-details-${mmsi}`);
                        if (detailsDiv && data.found) {
                            detailsDiv.innerHTML = `
                                <span class="info-label">Technology</span>
                                <span class="info-value">${data.technology}</span>
                            `;
                            
                            // Add installation details
                            const parentSection = detailsDiv.parentElement;
                            const yearRow = document.createElement('div');
                            yearRow.className = 'info-row';
                            yearRow.innerHTML = `
                                <span class="info-label">Installed</span>
                                <span class="info-value">${data.year} (${data.type})</span>
                            `;
                            parentSection.appendChild(yearRow);
                        } else if (detailsDiv) {
                            detailsDiv.innerHTML = `
                                <span class="info-label">Technology</span>
                                <span class="info-value">Wind-assisted (details pending)</span>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading wind tech:', error);
                        const detailsDiv = document.getElementById(`wind-tech-details-${mmsi}`);
                        if (detailsDiv) {
                            detailsDiv.innerHTML = `
                                <span class="info-label">Technology</span>
                                <span class="info-value">Wind-assisted</span>
                            `;
                        }
                    });
            }
        }
        
        // Close sidebar
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
        }
        
        // Show vessel route
        function showVesselRoute(mmsi, vesselName) {
            // Remove existing route and markers
            if (currentRoute) {
                map.removeLayer(currentRoute);
                currentRoute = null;
            }
            
            // Remove existing route markers (start/end dots)
            currentRouteMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            currentRouteMarkers = [];
            
            // Fetch route data
            fetch(`/ships/api/vessel/${mmsi}/route?hours=24`)
                .then(response => response.json())
                .then(route => {
                    if (route.length === 0) {
                        alert(`No route data available for ${vesselName}.\n\nThis vessel may not have been tracked yet, or has no position history in the last 24 hours.`);
                        console.log('No route data available for this vessel');
                        return;
                    }
                    
                    // Create polyline from route points
                    const latLngs = route.map(p => [p.lat, p.lon]);
                    currentRoute = L.polyline(latLngs, {
                        color: '#ffff00',  // Bright yellow for visibility
                        weight: 4,
                        opacity: 0.9,
                        dashArray: '10, 5'
                    }).addTo(map);
                    
                    // Add start marker (green)
                    const startMarker = L.circleMarker([route[0].lat, route[0].lon], {
                        radius: 8,
                        fillColor: '#00ff00',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(map);
                    startMarker.bindPopup(`
                        <b>${vesselName}</b><br>
                        <b style="color: #00ff00;">üü¢ Start Position</b><br>
                        üìç ${route[0].lat.toFixed(4)}¬∞N, ${route[0].lon.toFixed(4)}¬∞E<br>
                        üö¢ Speed: ${route[0].sog || 0} knots<br>
                        üß≠ Course: ${route[0].cog || 0}¬∞<br>
                        üïê ${new Date(route[0].timestamp).toLocaleString()}
                    `);
                    currentRouteMarkers.push(startMarker);
                    
                    // Add end marker (red)
                    const endMarker = L.circleMarker([route[route.length-1].lat, route[route.length-1].lon], {
                        radius: 8,
                        fillColor: '#ff0000',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(map);
                    endMarker.bindPopup(`
                        <b>${vesselName}</b><br>
                        <b style="color: #ff0000;">üî¥ Current Position</b><br>
                        üìç ${route[route.length-1].lat.toFixed(4)}¬∞N, ${route[route.length-1].lon.toFixed(4)}¬∞E<br>
                        üö¢ Speed: ${route[route.length-1].sog || 0} knots<br>
                        üß≠ Course: ${route[route.length-1].cog || 0}¬∞<br>
                        üïê ${new Date(route[route.length-1].timestamp).toLocaleString()}
                    `);
                    currentRouteMarkers.push(endMarker);
                    
                    // Add popup to route
                    const duration = new Date(route[route.length-1].timestamp) - new Date(route[0].timestamp);
                    const hours = Math.floor(duration / (1000 * 60 * 60));
                    currentRoute.bindPopup(`
                        <b>${vesselName}</b><br>
                        <b>Route (last 24 hours)</b><br>
                        üìç ${route.length} positions<br>
                        ‚è±Ô∏è ${hours} hours tracked<br>
                        <span style="color: #00ff00;">‚óè</span> Green = Start<br>
                        <span style="color: #ff0000;">‚óè</span> Red = Current
                    `);
                    
                    // Fit map to route
                    map.fitBounds(currentRoute.getBounds().pad(0.1));
                    
                    // Show success message
                    console.log(`Route loaded: ${route.length} positions over ${hours} hours`);
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    alert(`Error loading route for ${vesselName}.\n\nPlease try again later.`);
                });
        }
        
        // Load and refresh detailed ship types for filter dropdown
        let currentShipTypes = [];
        
        function loadShipTypes() {
            fetch('/ships/api/detailed-ship-types')
                .then(response => response.json())
                .then(types => {
                    if (Array.isArray(types) && types.length > 0) {
                        // Check if types have changed
                        const typesChanged = JSON.stringify(types) !== JSON.stringify(currentShipTypes);
                        
                        if (typesChanged) {
                            currentShipTypes = types;
                            const select = document.getElementById('filter-type');
                            const currentValue = select.value;
                            
                            // Clear options except "All Types"
                            while (select.options.length > 1) {
                                select.remove(1);
                            }
                            
                            // Add updated types
                            types.forEach(type => {
                                const option = document.createElement('option');
                                option.value = type.name;
                                option.textContent = `${type.name} (${type.count})`;
                                select.appendChild(option);
                            });
                            
                            // Restore selected value if it still exists
                            if (currentValue !== 'all') {
                                const exists = types.some(t => t.name === currentValue);
                                if (exists) {
                                    select.value = currentValue;
                                }
                            }
                            
                            console.log(`Ship types updated: ${types.length} types available`);
                        }
                    } else {
                        console.log('No detailed ship types available yet - waiting for emissions matcher to sync data');
                    }
                })
                .catch(error => console.error('Error loading ship types:', error));
        }
        
        // Load initially
        loadShipTypes();
        
        // Refresh ship types every 30 seconds
        setInterval(loadShipTypes, 30000);
        
        // Load vessel data from API
        function loadVessels(fitBounds = false) {
            fetch('/ships/api/vessels')
                .then(response => response.json())
                .then(vessels => {
                    // Update allVessels array
                    allVessels = vessels;
                    document.getElementById('total-vessels').textContent = vessels.length;
                    
                    // Add/update vessels on map
                    let newVesselsAdded = 0;
                    vessels.forEach(vessel => {
                        if (vessel.lat && vessel.lon) {
                            const isNew = !markers[vessel.mmsi];
                            updateVessel(vessel.mmsi, vessel);
                            if (isNew) newVesselsAdded++;
                        }
                    });
                    
                    if (newVesselsAdded > 0) {
                        console.log(`Added ${newVesselsAdded} new vessels to map`);
                    }
                    
                    // Check if MMSI is in URL to show specific route
                    const urlParams = new URLSearchParams(window.location.search);
                    const mmsi = urlParams.get('mmsi');
                    if (mmsi) {
                        const vessel = vessels.find(v => v.mmsi == mmsi);
                        if (vessel) {
                            showVesselRoute(parseInt(mmsi), vessel.name);
                        }
                    } else if (fitBounds) {
                        // Fit map to show all vessels (only on initial load)
                        if (Object.keys(markers).length > 0) {
                            const group = L.featureGroup(Object.values(markers));
                            map.fitBounds(group.getBounds().pad(0.1));
                        }
                    }
                })
                .catch(error => console.error('Error loading vessels:', error));
        }
        
        // Load initial data with bounds fitting
        loadVessels(true);
        
        // Refresh vessel list every 15 seconds to catch new ships
        setInterval(() => loadVessels(false), 15000);
        
        // Connect to WebSocket for live updates
        const socket = io({path: '/ships/socket.io'});
        
        socket.on('connect', () => {
            console.log('Connected to server');
        });
        
        socket.on('vessel_update', (data) => {
            // Update vessel in allVessels array
            const index = allVessels.findIndex(v => v.mmsi === data.mmsi);
            if (index >= 0) {
                allVessels[index] = {...allVessels[index], ...data.position};
            } else {
                allVessels.push({mmsi: data.mmsi, ...data.position});
            }
            updateVessel(data.mmsi, data.position);
        });
        
        socket.on('initial_data', (data) => {
            console.log('Received initial data:', data);
        });
        
        // Filter event listeners
        document.getElementById('filter-type').addEventListener('change', (e) => {
            currentFilters.type = e.target.value;
            applyFilters();
        });
        
        document.getElementById('filter-size').addEventListener('change', (e) => {
            currentFilters.size = e.target.value;
            applyFilters();
        });
    </script>
</body>
</html>
