<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Vessel Tracker</title>
    
    <!-- Leaflet CSS - Version 1.4.0 for Windy compatibility -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        
        #header {
            background: #16213e;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        #header h1 {
            font-size: 24px;
            color: #00d4ff;
        }
        
        #stats {
            display: flex;
            gap: 30px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #aaa;
            text-transform: uppercase;
        }
        
        #controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #aaa;
        }
        
        .filter-group select {
            background: #0f3460;
            color: #eee;
            border: 1px solid #00d4ff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        #map {
            height: calc(100vh - 120px);
            width: calc(100% - 400px);
            position: relative;
            float: left;
        }
        
        /* Sidebar Panel */
        #sidebar {
            width: 400px;
            height: calc(100vh - 120px);
            background: #16213e;
            float: right;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            padding: 20px;
            display: none;
        }
        
        #sidebar.active {
            display: block;
        }
        
        #sidebar h2 {
            color: #00d4ff;
            font-size: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 10px;
        }
        
        #sidebar .close-btn {
            float: right;
            background: #ff0000;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        #sidebar .close-btn:hover {
            background: #cc0000;
        }
        
        #sidebar .info-section {
            margin-bottom: 20px;
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
        }
        
        #sidebar .info-section h3 {
            color: #00d4ff;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        #sidebar .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #1a1a2e;
        }
        
        #sidebar .info-row:last-child {
            border-bottom: none;
        }
        
        #sidebar .info-label {
            color: #aaa;
            font-size: 13px;
        }
        
        #sidebar .info-value {
            color: #fff;
            font-size: 13px;
            font-weight: bold;
        }
        
        /* Legend */
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: rgba(22, 33, 62, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 1000;
            min-width: 200px;
        }
        
        .legend h3 {
            color: #00d4ff;
            font-size: 14px;
            margin-bottom: 10px;
            border-bottom: 1px solid #00d4ff;
            padding-bottom: 5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 12px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        
        .legend-size {
            font-size: 11px;
            color: #aaa;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #444;
        }
        
        /* Enhanced Popup */
        .leaflet-popup-content-wrapper {
            background: #16213e;
            color: #fff;
            border-radius: 8px;
        }
        
        .leaflet-popup-content {
            margin: 15px;
            min-width: 280px !important;
        }
        
        .leaflet-popup-tip {
            background: #16213e;
        }
        
        .vessel-popup {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-width: 300px;
        }
        
        .vessel-popup h3 {
            margin: 0 0 10px 0;
            color: #00d4ff;
            font-size: 18px;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 5px;
        }
        
        .vessel-photo {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .vessel-photo-placeholder {
            width: 100%;
            height: 150px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            position: relative;
        }
        
        .photo-loading {
            width: 100%;
            height: 150px;
            background: #2a2a3e;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .photo-loading-text {
            color: #00d4ff;
            font-size: 12px;
        }
        
        .vessel-popup table {
            width: 100%;
            font-size: 13px;
        }
        
        .vessel-popup td {
            padding: 4px 5px;
            vertical-align: top;
        }
        
        .vessel-popup td:first-child {
            font-weight: bold;
            color: #666;
            width: 100px;
        }
        
        .vessel-popup .ship-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .type-passenger { background: #ff00ff; color: white; }
        .type-cargo { background: #00ff00; color: black; }
        .type-tanker { background: #ff0000; color: white; }
        .type-other { background: #00d4ff; color: black; }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-active {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }
        
        .status-inactive {
            background: #666;
        }
        
        /* WASP Filter Button */
        #wasp-filter-btn {
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            color: #000;
            border: 3px solid #00ff00;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #wasp-filter-btn:hover {
            background: linear-gradient(135deg, #00ff00 0%, #00ff00 100%);
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.8);
            transform: scale(1.05);
        }
        
        #wasp-filter-btn.active {
            background: linear-gradient(135deg, #ff00ff 0%, #cc00cc 100%);
            border-color: #ff00ff;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
        }
        
        #wasp-filter-btn.active:hover {
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.8);
        }
        
        /* Wind Layer Toggle Button */
        #wind-toggle-btn {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #000;
            border: 3px solid #00d4ff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #wind-toggle-btn:hover {
            background: linear-gradient(135deg, #00d4ff 0%, #00d4ff 100%);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.8);
            transform: scale(1.05);
        }
        
        #wind-toggle-btn.active {
            background: linear-gradient(135deg, #ff6600 0%, #cc5200 100%);
            border-color: #ff6600;
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.5);
        }
        
        #wind-toggle-btn.active:hover {
            box-shadow: 0 0 30px rgba(255, 102, 0, 0.8);
        }
        
        /* Wind layer styles */
        .leaflet-tile-pane {
            z-index: 200;
        }
        
        /* Dark Mode Toggle Button */
        #dark-mode-btn {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #fff;
            border: 3px solid #7f8c8d;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(127, 140, 141, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #dark-mode-btn:hover {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            box-shadow: 0 0 30px rgba(127, 140, 141, 0.8);
            transform: scale(1.05);
        }
        
        #dark-mode-btn.active {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        
        #dark-mode-btn.active:hover {
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.8);
        }
        
        /* Advanced Filter Panel */
        #filter-panel {
            position: fixed;
            top: 120px;
            right: -420px;
            width: 400px;
            height: calc(100vh - 140px);
            background: rgba(22, 33, 62, 0.98);
            box-shadow: -5px 0 20px rgba(0,0,0,0.5);
            z-index: 2000;
            transition: right 0.3s ease;
            overflow-y: auto;
            border-left: 3px solid #00d4ff;
        }
        
        #filter-panel.open {
            right: 0;
        }
        
        #filter-panel-toggle {
            position: fixed;
            top: 200px;
            right: 0;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #000;
            border: none;
            border-radius: 8px 0 0 8px;
            padding: 15px 10px;
            cursor: pointer;
            z-index: 2001;
            font-size: 20px;
            font-weight: bold;
            box-shadow: -3px 0 10px rgba(0,0,0,0.3);
            transition: all 0.3s;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        
        #filter-panel-toggle:hover {
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            box-shadow: -5px 0 20px rgba(0,255,0,0.5);
        }
        
        #filter-panel-toggle.open {
            right: 400px;
        }
        
        .filter-panel-header {
            background: #0f3460;
            padding: 20px;
            border-bottom: 2px solid #00d4ff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .filter-panel-header h2 {
            color: #00d4ff;
            font-size: 20px;
            margin: 0 0 10px 0;
        }
        
        .filter-panel-content {
            padding: 20px;
        }
        
        .filter-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #0f3460;
        }
        
        .filter-section:last-child {
            border-bottom: none;
        }
        
        .filter-section h3 {
            color: #00d4ff;
            font-size: 14px;
            margin: 0 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .slider-container {
            margin-bottom: 20px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .slider-label-text {
            color: #aaa;
        }
        
        .slider-value {
            color: #00d4ff;
            font-weight: bold;
        }
        
        .slider-input {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #0f3460;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        .slider-input::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        .slider-input:hover::-webkit-slider-thumb {
            background: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
        }
        
        .slider-input:hover::-moz-range-thumb {
            background: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
        }
        
        .range-slider-container {
            margin-bottom: 20px;
        }
        
        .range-values {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 11px;
            color: #666;
        }
        
        .filter-reset-btn {
            width: 100%;
            background: #ff6600;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .filter-reset-btn:hover {
            background: #ff8800;
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.5);
        }
        
        .filter-stats {
            background: #0f3460;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        
        .filter-stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .filter-stats-row:last-child {
            margin-bottom: 0;
        }
        
        .filter-stats-label {
            color: #aaa;
        }
        
        .filter-stats-value {
            color: #00ff00;
            font-weight: bold;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-container label {
            color: #eee;
            font-size: 13px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üö¢ Real-Time Vessel Tracker</h1>
        
        <div style="display: flex; gap: 10px;">
            <a href="/ships/fleet-visualization" class="btn" style="background: #0f3460; color: #00d4ff; border: 1px solid #00d4ff; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; transition: all 0.3s;">üåê 3D Fleet</a>
            <a href="/ships/sql" class="btn" style="background: #0f3460; color: #00d4ff; border: 1px solid #00d4ff; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; transition: all 0.3s;">üíª SQL Query</a>
            <a href="/ships/database" class="btn" style="background: #0f3460; color: #00d4ff; border: 1px solid #00d4ff; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; transition: all 0.3s;">üóÑÔ∏è Database</a>
        </div>
        
        <div id="controls">
            <div class="filter-group">
                <label>Type:</label>
                <select id="filter-type">
                    <option value="all">All Types</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Size:</label>
                <select id="filter-size">
                    <option value="all">All Sizes</option>
                    <option value="large">Large (‚â•200m)</option>
                    <option value="medium">Medium (100-200m)</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Gross Tonnage:</label>
                <select id="filter-gt">
                    <option value="all">All GT</option>
                    <option value="under100">‚â§100 GT</option>
                    <option value="over100">>100 GT</option>
                    <option value="over1000">>1,000 GT (IMO)</option>
                    <option value="over5000">>5,000 GT (EU ETS)</option>
                </select>
            </div>
            
            <div class="filter-group">
                <button id="wasp-filter-btn" onclick="toggleWaspFilter()">
                    <span style="font-size: 20px;">üå¨Ô∏è</span>
                    <span>WIND-ASSISTED ONLY</span>
                </button>
            </div>
            
            <div class="filter-group">
                <button id="wind-toggle-btn" onclick="toggleWindLayer()">
                    <span style="font-size: 20px;">üí®</span>
                    <span>SHOW WIND DATA</span>
                </button>
            </div>
            
            <div class="filter-group">
                <button id="dark-mode-btn" onclick="toggleDarkMode()">
                    <span style="font-size: 20px;">üåô</span>
                    <span>DARK MODE</span>
                </button>
            </div>
            
            <div class="filter-group" id="wind-opacity-control" style="display: none;">
                <label>Wind Opacity:</label>
                <input type="range" id="wind-opacity-slider" min="0" max="100" value="50" 
                       oninput="updateWindOpacity(this.value)" style="width: 120px; cursor: pointer;">
                <span id="wind-opacity-value" style="margin-left: 8px; font-weight: bold;">50%</span>
            </div>
        </div>
        
        <div id="stats">
            <div class="stat">
                <div class="stat-value" id="total-vessels">0</div>
                <div class="stat-label">Total Vessels</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="active-vessels">0</div>
                <div class="stat-label">Active Tracking</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="vessels-with-gt">0</div>
                <div class="stat-label">With GT Data</div>
            </div>
            <div class="stat">
                <div class="stat-label">
                    <span class="status-indicator status-active"></span>
                    Live Updates
                </div>
            </div>
        </div>
    </div>
    
    <div id="map">
        <div class="legend" style="max-height: 500px; overflow-y: auto;">
            <h3>üé® Ship Type Colors</h3>
            <div class="legend-item">
                <div class="legend-color" style="background: #8B4513;"></div>
                <span>Bulk carrier</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF4500;"></div>
                <span>Container ship</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #32CD32;"></div>
                <span>General cargo</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #DC143C;"></div>
                <span>Oil tanker</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF1493;"></div>
                <span>Chemical tanker</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9370DB;"></div>
                <span>LNG carrier</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #BA55D3;"></div>
                <span>Gas carrier</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFD700;"></div>
                <span>Vehicle carrier</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFA500;"></div>
                <span>Ro-ro ship</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00CED1;"></div>
                <span>Refrigerated cargo</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #1E90FF;"></div>
                <span>Passenger ship</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #808080;"></div>
                <span>Other types</span>
            </div>
            <div class="legend-size">
                <strong>Size:</strong><br>
                ‚Ä¢ Large dot = ‚â•200m<br>
                ‚Ä¢ Small dot = 100-200m
            </div>
        </div>
    </div>
    
    <div id="sidebar">
        <button class="close-btn" onclick="closeSidebar()">‚úï Close</button>
        <h2 id="sidebar-title">Vessel Details</h2>
        <div id="sidebar-content"></div>
    </div>
    
    <!-- Advanced Filter Panel -->
    <button id="filter-panel-toggle" onclick="toggleFilterPanel()">‚öôÔ∏è FILTERS</button>
    
    <div id="filter-panel">
        <div class="filter-panel-header">
            <h2>üéõÔ∏è Advanced Filters</h2>
            <p style="color: #aaa; font-size: 12px; margin: 0;">Fine-tune vessel display with sliders</p>
        </div>
        
        <div class="filter-panel-content">
            <!-- Vessel Dimensions -->
            <div class="filter-section">
                <h3>üìè Vessel Dimensions</h3>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span class="slider-label-text">Length (m)</span>
                        <span class="slider-value"><span id="length-min-value">100</span> - <span id="length-max-value">500</span>m</span>
                    </div>
                    <input type="range" id="length-min-slider" class="slider-input" min="50" max="500" value="100" oninput="updateLengthFilter()">
                    <input type="range" id="length-max-slider" class="slider-input" min="50" max="500" value="500" oninput="updateLengthFilter()">
                    <div class="range-values">
                        <span>50m</span>
                        <span>500m</span>
                    </div>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span class="slider-label-text">Beam / Width (m)</span>
                        <span class="slider-value"><span id="beam-min-value">0</span> - <span id="beam-max-value">100</span>m</span>
                    </div>
                    <input type="range" id="beam-min-slider" class="slider-input" min="0" max="100" value="0" oninput="updateBeamFilter()">
                    <input type="range" id="beam-max-slider" class="slider-input" min="0" max="100" value="100" oninput="updateBeamFilter()">
                    <div class="range-values">
                        <span>0m</span>
                        <span>100m</span>
                    </div>
                </div>
            </div>
            
            <!-- Gross Tonnage -->
            <div class="filter-section">
                <h3>‚öñÔ∏è Gross Tonnage (GT)</h3>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span class="slider-label-text">GT Range</span>
                        <span class="slider-value"><span id="gt-min-value">0</span> - <span id="gt-max-value">200,000</span> GT</span>
                    </div>
                    <input type="range" id="gt-min-slider" class="slider-input" min="0" max="200000" step="1000" value="0" oninput="updateGTFilter()">
                    <input type="range" id="gt-max-slider" class="slider-input" min="0" max="200000" step="1000" value="200000" oninput="updateGTFilter()">
                    <div class="range-values">
                        <span>0 GT</span>
                        <span>200k GT</span>
                    </div>
                </div>
            </div>
            
            <!-- Speed -->
            <div class="filter-section">
                <h3>üöÄ Speed Over Ground (SOG)</h3>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span class="slider-label-text">Speed (knots)</span>
                        <span class="slider-value"><span id="speed-min-value">0</span> - <span id="speed-max-value">30</span> kn</span>
                    </div>
                    <input type="range" id="speed-min-slider" class="slider-input" min="0" max="30" step="0.5" value="0" oninput="updateSpeedFilter()">
                    <input type="range" id="speed-max-slider" class="slider-input" min="0" max="30" step="0.5" value="30" oninput="updateSpeedFilter()">
                    <div class="range-values">
                        <span>0 kn</span>
                        <span>30 kn</span>
                    </div>
                </div>
            </div>
            
            <!-- Data Availability -->
            <div class="filter-section">
                <h3>üìä Data Availability</h3>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="has-imo-checkbox" onchange="updateDataFilters()">
                    <label for="has-imo-checkbox">Only vessels with IMO number</label>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="has-gt-checkbox" onchange="updateDataFilters()">
                    <label for="has-gt-checkbox">Only vessels with GT data</label>
                </div>
            </div>
            
            <!-- Filter Stats -->
            <div class="filter-stats">
                <div class="filter-stats-row">
                    <span class="filter-stats-label">Vessels Shown:</span>
                    <span class="filter-stats-value" id="filter-stats-shown">0</span>
                </div>
                <div class="filter-stats-row">
                    <span class="filter-stats-label">Total Available:</span>
                    <span class="filter-stats-value" id="filter-stats-total">0</span>
                </div>
                <div class="filter-stats-row">
                    <span class="filter-stats-label">Filtered Out:</span>
                    <span class="filter-stats-value" id="filter-stats-filtered" style="color: #ff6600;">0</span>
                </div>
            </div>
            
            <!-- Reset Button -->
            <button class="filter-reset-btn" onclick="resetFilters()">üîÑ Reset All Filters</button>
        </div>
    </div>
    
    <!-- Leaflet JS - Version 1.4.0 for Windy compatibility -->
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
    
    <!-- Windy API -->
    <script src="https://api.windy.com/assets/map-forecast/libBoot.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // Initialize map - centered to show Europe and Atlantic routes
        const map = L.map('map').setView([48.0, -10.0], 5);
        
        // Map tile layers
        let lightTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        });
        
        let darkTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors ¬© CARTO',
            maxZoom: 19
        });
        
        // Start with light mode
        let isDarkMode = false;
        lightTileLayer.addTo(map);
        
        // Store markers and vessel data
        const markers = {};
        let allVessels = [];
        let currentFilters = {
            type: 'all',
            size: 'all',
            gt: 'all',
            waspOnly: false,
            // Range filters
            lengthMin: 100,
            lengthMax: 500,
            beamMin: 0,
            beamMax: 100,
            gtMin: 0,
            gtMax: 200000,
            speedMin: 0,
            speedMax: 30,
            // Checkbox filters
            hasIMO: false,
            hasEmissions: false,
            hasGT: false
        };
        let currentRoute = null; // Store current route polyline
        let currentRouteMarkers = []; // Store route start/end markers
        const photoCache = {}; // Cache photo results to avoid repeated requests
        let windLayer = null; // Store wind overlay layer
        
        // Toggle Dark Mode
        function toggleDarkMode() {
            const btn = document.getElementById('dark-mode-btn');
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                // Switch to dark mode
                map.removeLayer(lightTileLayer);
                darkTileLayer.addTo(map);
                btn.classList.add('active');
                btn.innerHTML = '<span style="font-size: 20px;">‚òÄÔ∏è</span><span>LIGHT MODE</span>';
            } else {
                // Switch to light mode
                map.removeLayer(darkTileLayer);
                lightTileLayer.addTo(map);
                btn.classList.remove('active');
                btn.innerHTML = '<span style="font-size: 20px;">üåô</span><span>DARK MODE</span>';
            }
        }
        
        // Detailed ship type colors (based on EU MRV detailed_ship_type)
        const detailedShipTypeColors = {
            'Bulk carrier': '#8B4513',              // Brown
            'Container ship': '#FF4500',            // Orange-Red
            'Container/ro-ro cargo ship': '#FF6347', // Tomato
            'General cargo ship': '#32CD32',        // Lime Green
            'Oil tanker': '#DC143C',                // Crimson
            'Chemical tanker': '#FF1493',           // Deep Pink
            'LNG carrier': '#9370DB',               // Medium Purple
            'Gas carrier': '#BA55D3',               // Medium Orchid
            'Vehicle carrier': '#FFD700',           // Gold
            'Ro-ro ship': '#FFA500',                // Orange
            'Ro-pax ship': '#FF8C00',               // Dark Orange
            'Refrigerated cargo carrier': '#00CED1', // Dark Turquoise
            'Passenger ship': '#1E90FF',            // Dodger Blue
            'Passenger ship (Cruise Passenger ship)': '#4169E1', // Royal Blue
            'Combination carrier': '#20B2AA',       // Light Sea Green
            'Other ship types': '#808080',          // Gray
            'Other ship types (Offshore)': '#696969' // Dim Gray
        };
        
        // Fallback colors for AIS ship type codes (if no detailed_ship_type)
        const aisShipTypeColors = {
            70: '#00ff00', // Cargo - Green
            80: '#ff0000'  // Tanker - Red
        };
        
        function getShipTypeInfo(vessel) {
            // Prefer detailed_ship_type from emissions data
            if (vessel.detailed_ship_type && detailedShipTypeColors[vessel.detailed_ship_type]) {
                return {
                    color: detailedShipTypeColors[vessel.detailed_ship_type],
                    name: vessel.detailed_ship_type,
                    badge: 'type-detailed'
                };
            }
            
            // Fallback to AIS ship_type
            const shipType = vessel.ship_type;
            if (shipType >= 70 && shipType < 80) {
                return { color: aisShipTypeColors[70], name: 'Cargo', badge: 'type-cargo' };
            }
            if (shipType >= 80 && shipType < 90) {
                return { color: aisShipTypeColors[80], name: 'Tanker', badge: 'type-tanker' };
            }
            
            // Default
            return { color: '#00ff00', name: 'Cargo', badge: 'type-cargo' };
        }
        
        // Create custom icon
        function createVesselIcon(vessel) {
            const isLarge = vessel.length >= 200;
            const typeInfo = getShipTypeInfo(vessel);
            const color = typeInfo.color;
            const isWindAssisted = vessel.wind_assisted === 1;
            
            // Add wind propulsion indicator (wind turbine icon)
            const windIndicator = isWindAssisted ? `<div style="position: absolute; top: -8px; right: -8px; font-size: 16px; filter: drop-shadow(0 0 3px #000);">üå¨Ô∏è</div>` : '';
            
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="position: relative;"><div style="background: ${color}; border: 2px solid ${isWindAssisted ? '#00ff00' : '#fff'}; border-radius: 50%; width: ${isLarge ? 16 : 12}px; height: ${isLarge ? 16 : 12}px; box-shadow: 0 0 ${isLarge ? 15 : 10}px ${color};"></div>${windIndicator}</div>`,
                iconSize: [isLarge ? 24 : 20, isLarge ? 24 : 20],
                iconAnchor: [isLarge ? 12 : 10, isLarge ? 12 : 10]
            });
        }
        
        // Create enhanced popup content with ship photo
        function createPopupContent(mmsi, vessel) {
            const hasPosition = vessel.lat !== undefined;
            const typeInfo = getShipTypeInfo(vessel);
            
            const popupId = `popup-${mmsi}`;
            
            const content = `
                <div class="vessel-popup" id="${popupId}">
                    <h3>${vessel.name}</h3>
                    <div class="photo-loading" id="photo-${mmsi}">
                        <div class="spinner"></div>
                        <div class="photo-loading-text">Loading photo...</div>
                    </div>
                    <span class="ship-type-badge ${typeInfo.badge}">${typeInfo.name}</span>
                    ${vessel.detailed_ship_type ? `<br><span style="font-size: 12px; color: #666;">Type: ${vessel.detailed_ship_type}</span>` : ''}
                    ${vessel.wind_assisted === 1 ? `
                        <br><span style="font-size: 13px; color: #00ff00; font-weight: bold;">üå¨Ô∏è Wind-Assisted Propulsion</span>
                        <div id="popup-wind-tech-${mmsi}" style="font-size: 11px; color: #aaa; margin-top: 5px;">Loading technology details...</div>
                    ` : ''}
                    <table>
                        <tr><td>MMSI:</td><td>${mmsi}</td></tr>
                        <tr><td>Flag:</td><td>${vessel.flag_state || 'Unknown'}</td></tr>
                        <tr><td>Length:</td><td>${vessel.length}m</td></tr>
                        <tr><td>Type Code:</td><td>${vessel.ship_type || 'N/A'}</td></tr>
                        ${vessel.imo ? `<tr><td>IMO:</td><td>${vessel.imo}</td></tr>` : ''}
                        ${vessel.call_sign ? `<tr><td>Call Sign:</td><td>${vessel.call_sign}</td></tr>` : ''}
                        ${hasPosition ? `
                            <tr><td>Position:</td><td>${vessel.lat.toFixed(4)}¬∞N, ${vessel.lon.toFixed(4)}¬∞E</td></tr>
                            <tr><td>Speed:</td><td>${vessel.sog} knots</td></tr>
                            <tr><td>Course:</td><td>${vessel.cog}¬∞</td></tr>
                            <tr><td>Updated:</td><td>${new Date(vessel.timestamp).toLocaleString()}</td></tr>
                        ` : '<tr><td colspan="2"><em>Waiting for position...</em></td></tr>'}
                    </table>
                </div>
            `;
            
            // Fetch photo asynchronously (with caching)
            setTimeout(() => {
                const photoContainer = document.getElementById(`photo-${mmsi}`);
                if (!photoContainer) return;
                
                // Check cache first
                if (photoCache[mmsi] !== undefined) {
                    if (photoCache[mmsi]) {
                        photoContainer.innerHTML = `<img src="${photoCache[mmsi]}" class="vessel-photo" alt="${vessel.name}" onerror="this.parentElement.innerHTML='<div class=\\'vessel-photo-placeholder\\'>üö¢</div>'">`;
                    } else {
                        photoContainer.innerHTML = '<div class="vessel-photo-placeholder">üö¢</div>';
                    }
                    return;
                }
                
                // Fetch from API
                fetch(`/ships/api/vessel/${mmsi}/photo`)
                    .then(response => {
                        if (!response.ok) throw new Error('Photo fetch failed');
                        return response.json();
                    })
                    .then(data => {
                        const photoUrl = data.photo_url;
                        photoCache[mmsi] = photoUrl; // Cache the result
                        
                        if (photoContainer) {
                            if (photoUrl) {
                                photoContainer.innerHTML = `<img src="${photoUrl}" class="vessel-photo" alt="${vessel.name}" onerror="this.parentElement.innerHTML='<div class=\\'vessel-photo-placeholder\\'>üö¢</div>'; photoCache[${mmsi}] = null;">`;
                            } else {
                                photoContainer.innerHTML = '<div class="vessel-photo-placeholder">üö¢</div>';
                            }
                        }
                    })
                    .catch(error => {
                        console.error(`Error loading photo for ${mmsi}:`, error);
                        photoCache[mmsi] = null; // Cache the failure
                        if (photoContainer) {
                            photoContainer.innerHTML = '<div class="vessel-photo-placeholder">üö¢</div>';
                        }
                    });
            }, 100);
            
            // Fetch wind technology details if vessel has wind propulsion
            if (vessel.wind_assisted === 1) {
                setTimeout(() => {
                    fetch(`/ships/api/vessel/${mmsi}/wind-tech`)
                        .then(response => response.json())
                        .then(data => {
                            const techDiv = document.getElementById(`popup-wind-tech-${mmsi}`);
                            if (techDiv && data.found) {
                                techDiv.innerHTML = `<strong>${data.technology}</strong><br>Installed: ${data.year} (${data.type})`;
                                techDiv.style.color = '#00ff00';
                            } else if (techDiv) {
                                techDiv.innerHTML = 'Wind-assisted (details pending)';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading wind tech:', error);
                            const techDiv = document.getElementById(`popup-wind-tech-${mmsi}`);
                            if (techDiv) {
                                techDiv.innerHTML = 'Wind-assisted propulsion';
                            }
                        });
                }, 150);
            }
            
            return content;
        }
        
        // Check if vessel passes filters
        function passesFilters(vessel) {
            // WASP filter - show only wind-assisted vessels
            if (currentFilters.waspOnly) {
                if (vessel.wind_assisted !== 1) {
                    return false;
                }
            }
            
            // Detailed type filter (by detailed_ship_type from emissions data)
            if (currentFilters.type !== 'all') {
                if (!vessel.detailed_ship_type || vessel.detailed_ship_type !== currentFilters.type) {
                    return false;
                }
            }
            
            // Size filter
            if (currentFilters.size !== 'all') {
                if (currentFilters.size === 'large' && vessel.length < 200) return false;
                if (currentFilters.size === 'medium' && (vessel.length < 100 || vessel.length >= 200)) return false;
            }
            
            // Gross Tonnage filter (regulatory compliance thresholds)
            if (currentFilters.gt !== 'all') {
                const gt = vessel.gross_tonnage;
                // Only filter if vessel has GT data
                if (gt) {
                    if (currentFilters.gt === 'under100' && gt > 100) return false;
                    if (currentFilters.gt === 'over100' && gt <= 100) return false;
                    if (currentFilters.gt === 'over1000' && gt <= 1000) return false; // IMO threshold
                    if (currentFilters.gt === 'over5000' && gt <= 5000) return false; // EU ETS threshold
                }
                // Vessels without GT data are excluded from GT filtering (don't show when GT filter active)
                else {
                    return false;
                }
            }
            
            // Range filters
            if (vessel.length && (vessel.length < currentFilters.lengthMin || vessel.length > currentFilters.lengthMax)) {
                return false;
            }
            
            if (vessel.beam && (vessel.beam < currentFilters.beamMin || vessel.beam > currentFilters.beamMax)) {
                return false;
            }
            
            if (vessel.gross_tonnage && (vessel.gross_tonnage < currentFilters.gtMin || vessel.gross_tonnage > currentFilters.gtMax)) {
                return false;
            }
            
            if (vessel.sog !== undefined && (vessel.sog < currentFilters.speedMin || vessel.sog > currentFilters.speedMax)) {
                return false;
            }
            
            // Checkbox filters
            if (currentFilters.hasIMO && (!vessel.imo || vessel.imo === 0)) {
                return false;
            }
            
            if (currentFilters.hasGT && (!vessel.gross_tonnage || vessel.gross_tonnage === 0)) {
                return false;
            }
            
            return true;
        }
        
        // Update vessel marker
        function updateVessel(mmsi, vessel) {
            if (!vessel.lat || !vessel.lon) return;
            
            // Check if vessel passes filters
            if (!passesFilters(vessel)) {
                // Remove marker if it exists
                if (markers[mmsi]) {
                    map.removeLayer(markers[mmsi]);
                    delete markers[mmsi];
                }
                return;
            }
            
            if (markers[mmsi]) {
                // Update existing marker
                markers[mmsi].setLatLng([vessel.lat, vessel.lon]);
                markers[mmsi].setPopupContent(createPopupContent(mmsi, vessel));
            } else {
                // Create new marker
                const marker = L.marker([vessel.lat, vessel.lon], {
                    icon: createVesselIcon(vessel)
                }).addTo(map);
                
                marker.bindPopup(createPopupContent(mmsi, vessel), {
                    maxWidth: 350,
                    minWidth: 300,
                    className: 'vessel-info-popup'
                });
                
                // Add click handler to show sidebar and route
                marker.on('click', () => {
                    showVesselDetails(mmsi, vessel);
                    showVesselRoute(mmsi, vessel.name);
                });
                
                markers[mmsi] = marker;
            }
            
            // Update stats
            updateStats();
        }
        
        // Apply filters to all vessels
        function applyFilters() {
            // Clear all markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            Object.keys(markers).forEach(key => delete markers[key]);
            
            // Re-add vessels that pass filters
            allVessels.forEach(vessel => {
                if (vessel.lat && vessel.lon) {
                    updateVessel(vessel.mmsi, vessel);
                }
            });
        }
        
        // Toggle WASP filter
        function toggleWaspFilter() {
            const btn = document.getElementById('wasp-filter-btn');
            currentFilters.waspOnly = !currentFilters.waspOnly;
            
            if (currentFilters.waspOnly) {
                btn.classList.add('active');
                btn.innerHTML = '<span style="font-size: 20px;">üå¨Ô∏è</span><span>SHOW ALL VESSELS</span>';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<span style="font-size: 20px;">üå¨Ô∏è</span><span>WIND-ASSISTED ONLY</span>';
            }
            
            applyFilters();
        }
        
        // Toggle Wind Layer
        function toggleWindLayer() {
            console.log('toggleWindLayer called');
            const btn = document.getElementById('wind-toggle-btn');
            console.log('Button found:', btn);
            
            if (windLayer) {
                // Hide wind layer
                console.log('Hiding wind layer');
                
                // Remove event listeners
                if (windLayer._updateFunction) {
                    map.off('moveend', windLayer._updateFunction);
                    map.off('zoomend', windLayer._updateFunction);
                }
                
                // Remove iframe
                if (windLayer.parentNode) {
                    windLayer.parentNode.removeChild(windLayer);
                }
                windLayer = null;
                btn.classList.remove('active');
                btn.innerHTML = '<span style="font-size: 20px;">üí®</span><span>SHOW WIND DATA</span>';
                
                // Hide opacity slider
                document.getElementById('wind-opacity-control').style.display = 'none';
            } else {
                // Show wind layer - Simple iframe overlay approach
                console.log('Showing wind layer with iframe');
                
                const center = map.getCenter();
                const zoom = map.getZoom();
                
                // Get opacity from slider
                const opacityValue = document.getElementById('wind-opacity-slider').value / 100;
                
                // Create iframe container
                const iframe = document.createElement('iframe');
                iframe.style.position = 'absolute';
                iframe.style.top = '0';
                iframe.style.left = '0';
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.pointerEvents = 'none';  // Click through to vessels above
                iframe.style.opacity = opacityValue.toString();
                iframe.style.zIndex = '400';  // Below vessels (which are at 600+)
                iframe.id = 'wind-iframe';  // Add ID for easy access
                
                // Windy embed URL with wind overlay only
                iframe.src = `https://embed.windy.com/embed2.html?lat=${center.lat}&lon=${center.lng}&zoom=${zoom}&level=surface&overlay=wind&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1`;
                
                document.getElementById('map').appendChild(iframe);
                windLayer = iframe;
                
                // Sync Windy iframe with Leaflet map movements
                const updateWindyPosition = () => {
                    const newCenter = map.getCenter();
                    const newZoom = map.getZoom();
                    iframe.src = `https://embed.windy.com/embed2.html?lat=${newCenter.lat}&lon=${newCenter.lng}&zoom=${newZoom}&level=surface&overlay=wind&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1`;
                };
                
                // Listen for map movements
                map.on('moveend', updateWindyPosition);
                map.on('zoomend', updateWindyPosition);
                
                // Store listeners so we can remove them later
                windLayer._updateFunction = updateWindyPosition;
                
                btn.classList.add('active');
                btn.innerHTML = '<span style="font-size: 20px;">üí®</span><span>HIDE WIND DATA</span>';
                
                // Show opacity slider
                document.getElementById('wind-opacity-control').style.display = 'flex';
                
                console.log('Wind layer iframe added with sync');
            }
        }
        
        // Update wind overlay opacity
        function updateWindOpacity(value) {
            const iframe = document.getElementById('wind-iframe');
            if (iframe) {
                iframe.style.opacity = (value / 100).toString();
            }
            document.getElementById('wind-opacity-value').textContent = value + '%';
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('active-vessels').textContent = Object.keys(markers).length;
        }
        
        // Show vessel details in sidebar
        function showVesselDetails(mmsi, vessel) {
            const sidebar = document.getElementById('sidebar');
            const title = document.getElementById('sidebar-title');
            const content = document.getElementById('sidebar-content');
            
            title.textContent = vessel.name || 'Unknown Vessel';
            
            const typeInfo = getShipTypeInfo(vessel);
            const hasPosition = vessel.lat !== undefined;
            
            content.innerHTML = `
                <div class="info-section">
                    <h3>üìã Basic Information</h3>
                    <div class="info-row">
                        <span class="info-label">MMSI</span>
                        <span class="info-value">${mmsi}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Vessel Name</span>
                        <span class="info-value">${vessel.name || 'Unknown'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Flag State</span>
                        <span class="info-value">${vessel.flag_state || 'Unknown'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ship Type</span>
                        <span class="info-value">${typeInfo.name} (${vessel.ship_type || 'N/A'})</span>
                    </div>
                    ${vessel.detailed_ship_type ? `
                    <div class="info-row">
                        <span class="info-label">Detailed Type</span>
                        <span class="info-value">${vessel.detailed_ship_type}</span>
                    </div>
                    ` : ''}
                    ${vessel.signatory_company ? `
                    <div class="info-row">
                        <span class="info-label">Company</span>
                        <span class="info-value">${vessel.signatory_company}</span>
                    </div>
                    ` : ''}
                </div>
                
                ${vessel.wind_assisted === 1 ? `
                <div class="info-section" style="background: linear-gradient(135deg, #1a3a1a 0%, #2d5a2d 100%); border-left: 4px solid #00ff00;">
                    <h3>üå¨Ô∏è Wind-Assisted Propulsion</h3>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value" style="color: #00ff00; font-weight: bold;">‚úì INSTALLED</span>
                    </div>
                    <div id="wind-tech-details-${mmsi}" class="info-row">
                        <span class="info-label">Technology</span>
                        <span class="info-value">Loading...</span>
                    </div>
                </div>
                ` : ''}
                
                <div class="info-section">
                    <h3>üìè Dimensions</h3>
                    <div class="info-row">
                        <span class="info-label">Length</span>
                        <span class="info-value">${vessel.length || 'N/A'}m</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Beam</span>
                        <span class="info-value">${vessel.beam || 'N/A'}m</span>
                    </div>
                    ${vessel.imo ? `
                    <div class="info-row">
                        <span class="info-label">IMO Number</span>
                        <span class="info-value">${vessel.imo}</span>
                    </div>
                    ` : ''}
                    ${vessel.call_sign ? `
                    <div class="info-row">
                        <span class="info-label">Call Sign</span>
                        <span class="info-value">${vessel.call_sign}</span>
                    </div>
                    ` : ''}
                </div>
                
                ${hasPosition ? `
                <div class="info-section">
                    <h3>üìç Current Position</h3>
                    <div class="info-row">
                        <span class="info-label">Latitude</span>
                        <span class="info-value">${vessel.lat.toFixed(6)}¬∞</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Longitude</span>
                        <span class="info-value">${vessel.lon.toFixed(6)}¬∞</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Speed</span>
                        <span class="info-value">${vessel.sog || 0} knots</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Course</span>
                        <span class="info-value">${vessel.cog || 0}¬∞</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Update</span>
                        <span class="info-value">${new Date(vessel.timestamp).toLocaleString()}</span>
                    </div>
                </div>
                ` : '<div class="info-section"><em>Waiting for position data...</em></div>'}
                
                <div class="info-section">
                    <h3>üîó External Links</h3>
                    <a href="https://www.marinetraffic.com/en/ais/details/ships/mmsi:${mmsi}" target="_blank" style="color: #00d4ff; display: block; margin: 10px 0;">View on MarineTraffic ‚Üí</a>
                    <a href="https://www.vesselfinder.com/vessels?name=${encodeURIComponent(vessel.name || '')}" target="_blank" style="color: #00d4ff; display: block; margin: 10px 0;">Search on VesselFinder ‚Üí</a>
                </div>
            `;
            
            sidebar.classList.add('active');
            
            // Fetch wind technology details if vessel has wind propulsion
            if (vessel.wind_assisted === 1) {
                fetch(`/ships/api/vessel/${mmsi}/wind-tech`)
                    .then(response => response.json())
                    .then(data => {
                        const detailsDiv = document.getElementById(`wind-tech-details-${mmsi}`);
                        if (detailsDiv && data.found) {
                            detailsDiv.innerHTML = `
                                <span class="info-label">Technology</span>
                                <span class="info-value">${data.technology}</span>
                            `;
                            
                            // Add installation details
                            const parentSection = detailsDiv.parentElement;
                            const yearRow = document.createElement('div');
                            yearRow.className = 'info-row';
                            yearRow.innerHTML = `
                                <span class="info-label">Installed</span>
                                <span class="info-value">${data.year} (${data.type})</span>
                            `;
                            parentSection.appendChild(yearRow);
                        } else if (detailsDiv) {
                            detailsDiv.innerHTML = `
                                <span class="info-label">Technology</span>
                                <span class="info-value">Wind-assisted (details pending)</span>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading wind tech:', error);
                        const detailsDiv = document.getElementById(`wind-tech-details-${mmsi}`);
                        if (detailsDiv) {
                            detailsDiv.innerHTML = `
                                <span class="info-label">Technology</span>
                                <span class="info-value">Wind-assisted</span>
                            `;
                        }
                    });
            }
        }
        
        // Close sidebar
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
        }
        
        // Show vessel route
        function showVesselRoute(mmsi, vesselName) {
            // Remove existing route and markers
            if (currentRoute) {
                map.removeLayer(currentRoute);
                currentRoute = null;
            }
            
            // Remove existing route markers (start/end dots)
            currentRouteMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            currentRouteMarkers = [];
            
            // Fetch route data
            fetch(`/ships/api/vessel/${mmsi}/route?hours=24`)
                .then(response => response.json())
                .then(route => {
                    if (route.length === 0) {
                        alert(`No route data available for ${vesselName}.\n\nThis vessel may not have been tracked yet, or has no position history in the last 24 hours.`);
                        console.log('No route data available for this vessel');
                        return;
                    }
                    
                    // Create polyline from route points
                    const latLngs = route.map(p => [p.lat, p.lon]);
                    currentRoute = L.polyline(latLngs, {
                        color: '#ffff00',  // Bright yellow for visibility
                        weight: 4,
                        opacity: 0.9,
                        dashArray: '10, 5'
                    }).addTo(map);
                    
                    // Add start marker (green)
                    const startMarker = L.circleMarker([route[0].lat, route[0].lon], {
                        radius: 8,
                        fillColor: '#00ff00',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(map);
                    startMarker.bindPopup(`
                        <b>${vesselName}</b><br>
                        <b style="color: #00ff00;">üü¢ Start Position</b><br>
                        üìç ${route[0].lat.toFixed(4)}¬∞N, ${route[0].lon.toFixed(4)}¬∞E<br>
                        üö¢ Speed: ${route[0].sog || 0} knots<br>
                        üß≠ Course: ${route[0].cog || 0}¬∞<br>
                        üïê ${new Date(route[0].timestamp).toLocaleString()}
                    `);
                    currentRouteMarkers.push(startMarker);
                    
                    // Add end marker (red)
                    const endMarker = L.circleMarker([route[route.length-1].lat, route[route.length-1].lon], {
                        radius: 8,
                        fillColor: '#ff0000',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(map);
                    endMarker.bindPopup(`
                        <b>${vesselName}</b><br>
                        <b style="color: #ff0000;">üî¥ Current Position</b><br>
                        üìç ${route[route.length-1].lat.toFixed(4)}¬∞N, ${route[route.length-1].lon.toFixed(4)}¬∞E<br>
                        üö¢ Speed: ${route[route.length-1].sog || 0} knots<br>
                        üß≠ Course: ${route[route.length-1].cog || 0}¬∞<br>
                        üïê ${new Date(route[route.length-1].timestamp).toLocaleString()}
                    `);
                    currentRouteMarkers.push(endMarker);
                    
                    // Add popup to route
                    const duration = new Date(route[route.length-1].timestamp) - new Date(route[0].timestamp);
                    const hours = Math.floor(duration / (1000 * 60 * 60));
                    currentRoute.bindPopup(`
                        <b>${vesselName}</b><br>
                        <b>Route (last 24 hours)</b><br>
                        üìç ${route.length} positions<br>
                        ‚è±Ô∏è ${hours} hours tracked<br>
                        <span style="color: #00ff00;">‚óè</span> Green = Start<br>
                        <span style="color: #ff0000;">‚óè</span> Red = Current
                    `);
                    
                    // Fit map to route
                    map.fitBounds(currentRoute.getBounds().pad(0.1));
                    
                    // Show success message
                    console.log(`Route loaded: ${route.length} positions over ${hours} hours`);
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    alert(`Error loading route for ${vesselName}.\n\nPlease try again later.`);
                });
        }
        
        // Load and refresh detailed ship types for filter dropdown
        let currentShipTypes = [];
        
        function loadShipTypes() {
            fetch('/ships/api/detailed-ship-types')
                .then(response => response.json())
                .then(types => {
                    if (Array.isArray(types) && types.length > 0) {
                        // Check if types have changed
                        const typesChanged = JSON.stringify(types) !== JSON.stringify(currentShipTypes);
                        
                        if (typesChanged) {
                            currentShipTypes = types;
                            const select = document.getElementById('filter-type');
                            const currentValue = select.value;
                            
                            // Clear options except "All Types"
                            while (select.options.length > 1) {
                                select.remove(1);
                            }
                            
                            // Add updated types
                            types.forEach(type => {
                                const option = document.createElement('option');
                                option.value = type.name;
                                option.textContent = `${type.name} (${type.count})`;
                                select.appendChild(option);
                            });
                            
                            // Restore selected value if it still exists
                            if (currentValue !== 'all') {
                                const exists = types.some(t => t.name === currentValue);
                                if (exists) {
                                    select.value = currentValue;
                                }
                            }
                            
                            console.log(`Ship types updated: ${types.length} types available`);
                        }
                    } else {
                        console.log('No detailed ship types available yet - waiting for emissions matcher to sync data');
                    }
                })
                .catch(error => console.error('Error loading ship types:', error));
        }
        
        // Load initially
        loadShipTypes();
        
        // Refresh ship types every 30 seconds
        setInterval(loadShipTypes, 30000);
        
        // Load vessel data from API
        function loadVessels(fitBounds = false) {
            fetch('/ships/api/vessels')
                .then(response => response.json())
                .then(vessels => {
                    // Update allVessels array
                    allVessels = vessels;
                    document.getElementById('total-vessels').textContent = vessels.length;
                    
                    // Count vessels with GT data
                    const vesselsWithGT = vessels.filter(v => v.gross_tonnage != null && v.gross_tonnage > 0).length;
                    document.getElementById('vessels-with-gt').textContent = vesselsWithGT;
                    
                    // Add/update vessels on map
                    let newVesselsAdded = 0;
                    vessels.forEach(vessel => {
                        if (vessel.lat && vessel.lon) {
                            const isNew = !markers[vessel.mmsi];
                            updateVessel(vessel.mmsi, vessel);
                            if (isNew) newVesselsAdded++;
                        }
                    });
                    
                    if (newVesselsAdded > 0) {
                        console.log(`Added ${newVesselsAdded} new vessels to map`);
                    }
                    
                    // Check if MMSI is in URL to show specific route
                    const urlParams = new URLSearchParams(window.location.search);
                    const mmsi = urlParams.get('mmsi');
                    if (mmsi) {
                        const vessel = vessels.find(v => v.mmsi == mmsi);
                        if (vessel) {
                            showVesselRoute(parseInt(mmsi), vessel.name);
                        }
                    } else if (fitBounds) {
                        // Fit map to show all vessels (only on initial load)
                        if (Object.keys(markers).length > 0) {
                            const group = L.featureGroup(Object.values(markers));
                            map.fitBounds(group.getBounds().pad(0.1));
                        }
                    }
                })
                .catch(error => console.error('Error loading vessels:', error));
        }
        
        // Load initial data with bounds fitting
        loadVessels(true);
        
        // Refresh vessel list every 15 seconds to catch new ships
        setInterval(() => loadVessels(false), 15000);
        
        // Connect to WebSocket for live updates
        const socket = io({path: '/ships/socket.io'});
        
        socket.on('connect', () => {
            console.log('Connected to server');
        });
        
        socket.on('vessel_update', (data) => {
            // Update vessel in allVessels array
            const index = allVessels.findIndex(v => v.mmsi === data.mmsi);
            if (index >= 0) {
                allVessels[index] = {...allVessels[index], ...data.position};
            } else {
                allVessels.push({mmsi: data.mmsi, ...data.position});
            }
            updateVessel(data.mmsi, data.position);
        });
        
        socket.on('initial_data', (data) => {
            console.log('Received initial data:', data);
        });
        
        // Filter event listeners
        document.getElementById('filter-type').addEventListener('change', (e) => {
            currentFilters.type = e.target.value;
            applyFilters();
        });
        
        document.getElementById('filter-size').addEventListener('change', (e) => {
            currentFilters.size = e.target.value;
            applyFilters();
        });
        
        document.getElementById('filter-gt').addEventListener('change', (e) => {
            currentFilters.gt = e.target.value;
            applyFilters();
        });
        
        // ========== ADVANCED FILTER PANEL FUNCTIONS ==========
        
        // Toggle filter panel
        function toggleFilterPanel() {
            const panel = document.getElementById('filter-panel');
            const toggle = document.getElementById('filter-panel-toggle');
            panel.classList.toggle('open');
            toggle.classList.toggle('open');
        }
        
        // Update length filter
        function updateLengthFilter() {
            const minSlider = document.getElementById('length-min-slider');
            const maxSlider = document.getElementById('length-max-slider');
            let minVal = parseInt(minSlider.value);
            let maxVal = parseInt(maxSlider.value);
            
            // Ensure min doesn't exceed max
            if (minVal > maxVal) {
                minVal = maxVal;
                minSlider.value = minVal;
            }
            
            currentFilters.lengthMin = minVal;
            currentFilters.lengthMax = maxVal;
            
            document.getElementById('length-min-value').textContent = minVal;
            document.getElementById('length-max-value').textContent = maxVal;
            
            applyFilters();
        }
        
        // Update beam filter
        function updateBeamFilter() {
            const minSlider = document.getElementById('beam-min-slider');
            const maxSlider = document.getElementById('beam-max-slider');
            let minVal = parseInt(minSlider.value);
            let maxVal = parseInt(maxSlider.value);
            
            if (minVal > maxVal) {
                minVal = maxVal;
                minSlider.value = minVal;
            }
            
            currentFilters.beamMin = minVal;
            currentFilters.beamMax = maxVal;
            
            document.getElementById('beam-min-value').textContent = minVal;
            document.getElementById('beam-max-value').textContent = maxVal;
            
            applyFilters();
        }
        
        // Update GT filter
        function updateGTFilter() {
            const minSlider = document.getElementById('gt-min-slider');
            const maxSlider = document.getElementById('gt-max-slider');
            let minVal = parseInt(minSlider.value);
            let maxVal = parseInt(maxSlider.value);
            
            if (minVal > maxVal) {
                minVal = maxVal;
                minSlider.value = minVal;
            }
            
            currentFilters.gtMin = minVal;
            currentFilters.gtMax = maxVal;
            
            document.getElementById('gt-min-value').textContent = minVal.toLocaleString();
            document.getElementById('gt-max-value').textContent = maxVal.toLocaleString();
            
            applyFilters();
        }
        
        // Update speed filter
        function updateSpeedFilter() {
            const minSlider = document.getElementById('speed-min-slider');
            const maxSlider = document.getElementById('speed-max-slider');
            let minVal = parseFloat(minSlider.value);
            let maxVal = parseFloat(maxSlider.value);
            
            if (minVal > maxVal) {
                minVal = maxVal;
                minSlider.value = minVal;
            }
            
            currentFilters.speedMin = minVal;
            currentFilters.speedMax = maxVal;
            
            document.getElementById('speed-min-value').textContent = minVal.toFixed(1);
            document.getElementById('speed-max-value').textContent = maxVal.toFixed(1);
            
            applyFilters();
        }
        
        // Update data availability filters
        function updateDataFilters() {
            currentFilters.hasIMO = document.getElementById('has-imo-checkbox').checked;
            currentFilters.hasGT = document.getElementById('has-gt-checkbox').checked;
            applyFilters();
        }
        
        // Reset all filters
        function resetFilters() {
            // Reset range filters
            currentFilters.lengthMin = 100;
            currentFilters.lengthMax = 500;
            currentFilters.beamMin = 0;
            currentFilters.beamMax = 100;
            currentFilters.gtMin = 0;
            currentFilters.gtMax = 200000;
            currentFilters.speedMin = 0;
            currentFilters.speedMax = 30;
            
            // Reset checkbox filters
            currentFilters.hasIMO = false;
            currentFilters.hasGT = false;
            
            // Reset UI elements
            document.getElementById('length-min-slider').value = 100;
            document.getElementById('length-max-slider').value = 500;
            document.getElementById('beam-min-slider').value = 0;
            document.getElementById('beam-max-slider').value = 100;
            document.getElementById('gt-min-slider').value = 0;
            document.getElementById('gt-max-slider').value = 200000;
            document.getElementById('speed-min-slider').value = 0;
            document.getElementById('speed-max-slider').value = 30;
            
            document.getElementById('has-imo-checkbox').checked = false;
            document.getElementById('has-gt-checkbox').checked = false;
            
            // Update displays
            document.getElementById('length-min-value').textContent = '100';
            document.getElementById('length-max-value').textContent = '500';
            document.getElementById('beam-min-value').textContent = '0';
            document.getElementById('beam-max-value').textContent = '100';
            document.getElementById('gt-min-value').textContent = '0';
            document.getElementById('gt-max-value').textContent = '200,000';
            document.getElementById('speed-min-value').textContent = '0.0';
            document.getElementById('speed-max-value').textContent = '30.0';
            
            // Reset dropdown filters
            document.getElementById('filter-type').value = 'all';
            document.getElementById('filter-size').value = 'all';
            document.getElementById('filter-gt').value = 'all';
            currentFilters.type = 'all';
            currentFilters.size = 'all';
            currentFilters.gt = 'all';
            
            // Reset WASP filter
            if (currentFilters.waspOnly) {
                toggleWaspFilter();
            }
            
            applyFilters();
        }
        
        // Update filter statistics
        function updateFilterStats() {
            const shown = Object.keys(markers).length;
            const total = allVessels.length;
            const filtered = total - shown;
            
            document.getElementById('filter-stats-shown').textContent = shown.toLocaleString();
            document.getElementById('filter-stats-total').textContent = total.toLocaleString();
            document.getElementById('filter-stats-filtered').textContent = filtered.toLocaleString();
        }
        
        // Override applyFilters to include stats update
        const originalApplyFilters = applyFilters;
        applyFilters = function() {
            originalApplyFilters();
            updateFilterStats();
        };
    </script>
</body>
</html>
